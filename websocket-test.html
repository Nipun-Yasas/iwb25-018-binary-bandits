<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test - Insurance Claims Dashboard</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-weight: bold; 
        }
        .connected { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .disconnected { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .message { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 4px; 
            font-family: monospace; 
            white-space: pre-wrap; 
        }
        .controls { 
            margin: 20px 0; 
        }
        button { 
            padding: 8px 16px; 
            margin: 5px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .primary { 
            background: #007bff; 
            color: white; 
        }
        .danger { 
            background: #dc3545; 
            color: white; 
        }
        .success { 
            background: #28a745; 
            color: white; 
        }
        .messages-container { 
            height: 400px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            padding: 10px; 
            background: #fafafa; 
        }
        .grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-top: 20px; 
        }
        h2 { 
            color: #333; 
            border-bottom: 2px solid #007bff; 
            padding-bottom: 5px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔌 WebSocket Integration Test</h1>
        <p>This page tests the WebSocket connection between the frontend and backend for real-time updates.</p>
        
        <!-- Connection Status -->
        <div id="status" class="status disconnected">
            📡 Status: Disconnected
        </div>

        <!-- Controls -->
        <div class="controls">
            <button id="connectBtn" class="primary" onclick="connect()">Connect</button>
            <button id="disconnectBtn" class="danger" onclick="disconnect()" disabled>Disconnect</button>
            <button class="success" onclick="sendPing()">Send Ping</button>
            <button class="primary" onclick="testClaimUpdate()">Test Claim Update</button>
            <button class="primary" onclick="clearMessages()">Clear Messages</button>
        </div>

        <div class="grid">
            <!-- WebSocket Messages -->
            <div>
                <h2>📨 WebSocket Messages</h2>
                <div id="messages" class="messages-container">
                    <div class="message">Waiting for WebSocket connection...</div>
                </div>
            </div>

            <!-- API Test Results -->
            <div>
                <h2>🧪 API Test Results</h2>
                <div id="apiResults" class="messages-container">
                    <div class="message">Click "Test Claim Update" to trigger API calls that should generate WebSocket events.</div>
                </div>
            </div>
        </div>

        <!-- Test Instructions -->
        <div style="margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 4px;">
            <h3>🧪 Test Instructions:</h3>
            <ol>
                <li><strong>Connect:</strong> Click "Connect" to establish WebSocket connection to ws://localhost:8082/ws</li>
                <li><strong>Ping Test:</strong> Click "Send Ping" to test basic communication (should receive "pong")</li>
                <li><strong>Real-time Test:</strong> Click "Test Claim Update" to update a claim status via API</li>
                <li><strong>Expected Result:</strong> API call should trigger WebSocket broadcast with claim update event</li>
                <li><strong>Verify:</strong> Check both WebSocket messages and API results panels</li>
            </ol>
        </div>
    </div>

    <script>
        let ws = null;
        let messageCount = 0;

        function addMessage(content, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.textContent = `[${new Date().toLocaleTimeString()}] ${content}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            messageCount++;
        }

        function addApiResult(content) {
            const apiDiv = document.getElementById('apiResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'message';
            resultDiv.textContent = `[${new Date().toLocaleTimeString()}] ${content}`;
            apiDiv.appendChild(resultDiv);
            apiDiv.scrollTop = apiDiv.scrollHeight;
        }

        function updateStatus(connected, clientId = null) {
            const statusDiv = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.innerHTML = `✅ Status: Connected${clientId ? ` (ID: ${clientId})` : ''}`;
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.innerHTML = '❌ Status: Disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addMessage('Already connected!');
                return;
            }

            addMessage('🔌 Connecting to WebSocket...');
            ws = new WebSocket('ws://localhost:8082/ws');

            ws.onopen = function(event) {
                addMessage('✅ WebSocket connected successfully!');
                updateStatus(true);
            };

            ws.onmessage = function(event) {
                addMessage(`📨 Received: ${event.data}`);
                
                try {
                    const message = JSON.parse(event.data);
                    if (message.type === 'connection_established') {
                        updateStatus(true, message.payload.client_id);
                        addMessage(`🎉 Connection established with client ID: ${message.payload.client_id}`);
                    } else if (message.type === 'claim_updated') {
                        addMessage(`🔄 CLAIM UPDATE EVENT: ${JSON.stringify(message.payload, null, 2)}`);
                    } else if (message.type === 'fraud_alert_created') {
                        addMessage(`🚨 FRAUD ALERT CREATED: ${JSON.stringify(message.payload, null, 2)}`);
                    } else if (message.type === 'fraud_alert_dismissed') {
                        addMessage(`🚨 FRAUD ALERT DISMISSED: ${JSON.stringify(message.payload, null, 2)}`);
                    } else if (message.type === 'dashboard_stats') {
                        addMessage(`📊 DASHBOARD STATS UPDATE: ${JSON.stringify(message.payload, null, 2)}`);
                    }
                } catch (e) {
                    // Not JSON, just log as text
                    if (event.data === 'pong') {
                        addMessage('🏓 Received pong response - connection is alive!');
                    }
                }
            };

            ws.onclose = function(event) {
                addMessage(`👋 WebSocket closed: Code ${event.code}, Reason: ${event.reason || 'No reason provided'}`);
                updateStatus(false);
            };

            ws.onerror = function(error) {
                addMessage(`🚨 WebSocket error: ${error}`);
                updateStatus(false);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
                addMessage('👋 Disconnected from WebSocket');
                updateStatus(false);
            }
        }

        function sendPing() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send('ping');
                addMessage('🏓 Sent ping to server');
            } else {
                addMessage('❌ WebSocket not connected');
            }
        }

        async function testClaimUpdate() {
            addApiResult('🧪 Starting claim update test...');
            
            try {
                // Test updating a claim status
                const response = await fetch('http://localhost:8080/api/claims/CLM-47254/status', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status: Math.random() > 0.5 ? 'approved' : 'pending'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    addApiResult(`✅ Claim update successful: ${JSON.stringify(result, null, 2)}`);
                    addApiResult('🔄 This should trigger a WebSocket broadcast event!');
                } else {
                    addApiResult(`❌ API call failed: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                addApiResult(`🚨 Error calling API: ${error.message}`);
            }
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '<div class="message">Messages cleared...</div>';
            document.getElementById('apiResults').innerHTML = '<div class="message">API results cleared...</div>';
            messageCount = 0;
        }

        // Auto-connect on page load
        window.onload = function() {
            addMessage('🚀 WebSocket test page loaded');
            addMessage('💡 Click "Connect" to establish WebSocket connection');
        };
    </script>
</body>
</html>
